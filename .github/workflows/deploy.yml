name: Deploy to Github Pages

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]

jobs:
    build:
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - name: Checkout config repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Checkout content repository (ObsidianVault)
              uses: actions/checkout@v4
              with:
                  repository: jasonchio-cn/ObsidianVault
                  path: content-source
                  token: ${{ secrets.PAT_TOKEN }}

            - name: Merge content from ObsidianVault
              run: |
                  # æ£€æŸ¥ content-source çš„ content ç›®å½•æ˜¯å¦å­˜åœ¨
                  if [ -d "content-source/content" ]; then
                      echo "âœ“ å‘ç° content-source/content ç›®å½•"
                      
                      # å¤‡ä»½ç°æœ‰ content ç›®å½•ï¼ˆå¦‚æœæœ‰ï¼‰
                      if [ -d "content" ]; then
                          echo "å¤‡ä»½ç°æœ‰ content ç›®å½• â†’ content.bak"
                          mv content content.bak
                      fi
                      
                      # ä» ObsidianVault å¤åˆ¶ content ç›®å½•
                      cp -r content-source/content .
                      echo "âœ“ ä» ObsidianVault å¤åˆ¶ content ç›®å½•æˆåŠŸ"
                  else
                      echo "âš ï¸ content-source/content ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å†…å®¹åˆå¹¶"
                      
                      # åˆ›å»ºç©ºçš„ content ç›®å½•ï¼ˆç¡®ä¿æ„å»ºä¸ä¼šå¤±è´¥ï¼‰
                      mkdir -p content
                  fi

            - name: Cache Hugo resources
              uses: actions/cache@v4
              env:
                  cache-name: cache-hugo-resources
              with:
                  path: resources
                  key: ${{ env.cache-name }}

            - uses: actions/setup-go@v5
              with:
                  go-version: "^1.17.0"
            - run: go version

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v2
              with:
                  hugo-version: "latest"
                  extended: true

            - name: Download dependencies
              run: hugo mod get -u

            - name: Build
              run: hugo --minify --gc --configDir config

            - name: Deploy ğŸš€
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  branch: gh-pages
                  folder: public
                  clean: true
                  single-commit: true
