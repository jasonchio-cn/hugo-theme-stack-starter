name: Deploy to GitHub Pages Repository

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]
    repository_dispatch:
        types: [content-update]

jobs:
    build:
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - name: Checkout config repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Checkout content repository (ObsidianVault)
              uses: actions/checkout@v4
              with:
                  repository: jasonchio-cn/ObsidianVault
                  path: content-source
                  token: ${{ secrets.PAT_TOKEN }}

            - name: Merge content from ObsidianVault
              run: |
                  # åˆ›å»º content ç›®å½•ç»“æž„
                  mkdir -p content/post

                  # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—§çš„ content ç›®å½•å¹¶å¤‡ä»½
                  if [ -d "content" ]; then
                      echo "å¤‡ä»½çŽ°æœ‰ content ç›®å½• â†’ content.bak"
                      rm -rf content.bak
                      mv content content.bak
                  fi

                  # é‡æ–°åˆ›å»º content ç›®å½•ç»“æž„
                  mkdir -p content/post

                  # ä»Ž ObsidianVault æ ¹ç›®å½•åŒæ­¥ Markdown æ–‡ä»¶åˆ° content/post/ï¼ˆæŽ’é™¤ README.mdï¼‰
                  echo "ðŸ“ ä»Ž ObsidianVault æ ¹ç›®å½•åŒæ­¥ Markdown æ–‡ä»¶ï¼ˆæŽ’é™¤ README.mdï¼‰..."
                  find content-source -maxdepth 1 -type f -name "*.md" ! -iname "README.md" -exec cp {} content/post/ \;

                  # ç»Ÿè®¡åŒæ­¥çš„æ–‡ä»¶æ•°é‡
                  file_count=$(find content-source -maxdepth 1 -type f -name "*.md" ! -iname "README.md" | wc -l)
                  echo "âœ“ åŒæ­¥äº† $file_count ä¸ª Markdown æ–‡ä»¶"

                  # åŒæ­¥èµ„æºç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  if [ -d "content-source/assets" ]; then
                      echo "ðŸ“ åŒæ­¥ assets ç›®å½•..."
                      cp -r content-source/assets content/
                  fi

                  echo "âœ“ å†…å®¹åŒæ­¥å®Œæˆ"

            - name: Cache Hugo resources
              uses: actions/cache@v4
              env:
                  cache-name: cache-hugo-resources
              with:
                  path: resources
                  key: ${{ env.cache-name }}

            - uses: actions/setup-go@v5
              with:
                  go-version: "^1.17.0"
            - run: go version

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v2
              with:
                  hugo-version: "latest"
                  extended: true

            - name: Download dependencies
              run: hugo mod get -u

            - name: Build
              run: hugo --minify --gc --configDir config

            - name: Deploy ðŸš€
              if: github.event_name != 'pull_request'
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  token: ${{ secrets.PAT_TOKEN }}
                  repository-name: jasonchio-cn/jasonchio-cn.github.io
                  branch: main
                  folder: public
                  clean: true
                  clean-exclude: |
                      README.md
                  single-commit: true

            - name: Install rsync
              if: github.event_name != 'pull_request'
              run: sudo apt-get update && sudo apt-get install -y rsync

            - name: Configure SSH
              if: github.event_name != 'pull_request'
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519
                  ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

            - name: Deploy to Remote Server (rsync)
              if: github.event_name != 'pull_request'
              run: |
                  rsync -az --delete \
                      -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519" \
                      public/ \
                      ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_TARGET_DIR }}/
